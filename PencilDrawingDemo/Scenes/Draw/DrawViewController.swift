//
//  DrawViewController.swift
//  PencilDrawingDemo
//
//  Created by Konstantin Stolyarenko on 11.09.2023.
//  Copyright Â© 2023 SKS. All rights reserved.
//
//  This file was generated by the SKS Clean Swift Xcode Templates
//  with inspiration from http://clean-swift.com
//

import UIKit
import PencilKit
import PhotosUI

// MARK: - DrawDisplayLogic Protocol

protocol DrawDisplayLogic: AnyObject {}

// MARK: - DrawViewController

class DrawViewController: UIViewController {

    // MARK: - Outlets

    @IBOutlet private var saveBarButtonItem: UIBarButtonItem!
    @IBOutlet private var inputDeviceBarButtonItem: UIBarButtonItem!
    @IBOutlet private var canvasView: PKCanvasView!

    // MARK: - Private Properties

    private var interactor: DrawBusinessLogic?
    private var router: (DrawRoutingLogic & DrawDataPassing)?

    private var drawing = PKDrawing()
    private let toolPicker = PKToolPicker()

    private var isPencilOnly = false {
        didSet {
            canvasView.drawingPolicy = isPencilOnly ? .pencilOnly : .anyInput
            inputDeviceBarButtonItem.title = isPencilOnly ? Const.Draw.dragButtonTitle : Const.Draw.drawButtonTitle
        }
    }

    // MARK: - Init

    class func instantiate() -> DrawViewController {
        let name = "\(DrawViewController.self)"
        let storyboard = UIStoryboard(name: name, bundle: nil)
        let vc = storyboard.instantiateViewController(withIdentifier: name) as! DrawViewController
        vc.setup()
        return vc
    }

    // MARK: - Setup

    private func setup() {
        let viewController = self
        let interactor = DrawInteractor()
        let presenter = DrawPresenter()
        let router = DrawRouter()
        viewController.interactor = interactor
        viewController.router = router
        interactor.presenter = presenter
        presenter.viewController = viewController
        router.viewController = viewController
        router.dataStore = interactor
    }

    // MARK: - View Lifecycle Properties

    override var preferredStatusBarStyle: UIStatusBarStyle {
        return .default
    }

    override var prefersHomeIndicatorAutoHidden: Bool {
        return true
    }

    // MARK: - View Lifecycle Methods

    override func viewDidLoad() {
        super.viewDidLoad()

        setupView()
    }

    // MARK: - Actions

    @IBAction private func inputDeviceButtonTapped(_ sender: Any) {
        isPencilOnly.toggle()
    }

    @IBAction private func saveButtonTapped(_ sender: Any) {
        saveImage()
    }

    // MARK: - Private Methods

    private func setupView() {
        isPencilOnly = false

        setupToolPicker()
        setupCanvas()
    }

    private func setupCanvas() {
        canvasView.minimumZoomScale = Const.Draw.minZoomScale
        canvasView.maximumZoomScale = Const.Draw.maxZoomScale
        canvasView.zoomScale = Const.Draw.minZoomScale

        canvasView.delegate = self
        canvasView.drawing = drawing

        canvasView.alwaysBounceVertical = true
        canvasView.becomeFirstResponder()
    }

    private func setupToolPicker() {
        toolPicker.setVisible(true, forFirstResponder: canvasView)
        toolPicker.addObserver(canvasView)
    }

    private func saveImage() {
        guard let image = renderImage() else { return }
        PHPhotoLibrary.shared().performChanges {
            PHAssetChangeRequest.creationRequestForAsset(from: image)
        }
    }

    private func renderImage() -> UIImage? {
        UIGraphicsBeginImageContextWithOptions(canvasView.bounds.size, false, UIScreen.main.scale)
        canvasView.drawHierarchy(in: canvasView.bounds, afterScreenUpdates: true)
        let image = UIGraphicsGetImageFromCurrentImageContext()
        UIGraphicsEndImageContext()
        return image
    }
}

// MARK: - DrawDisplayLogic Extension

extension DrawViewController: DrawDisplayLogic {}

// MARK: - PKCanvasViewDelegate Extension

extension DrawViewController: PKCanvasViewDelegate {}

// MARK: - PKToolPickerObserver Extension

extension DrawViewController: PKToolPickerObserver {}
